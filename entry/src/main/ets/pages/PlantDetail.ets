import { PottedPlantsComponent } from '../view/PottedPlantsComponent'
import { AIComponent } from '../view/AIComponent';
import { SwiperComponent } from '../view/SwiperComponent';
import EnvironmentViewModel from '../viewmodel/EnvironmentViewModel';
import { MqttMessage } from '@ohos/mqtt';
import MQTTUtil from '../common/utils/MQTTUtil';
import router from '@ohos.router';

@Entry
@Component
struct Index {
  @State item: EnvironmentViewModel = new EnvironmentViewModel();
  @State aiButtonScale: number = 1;
  @State headerOpacity: number = 0;
  @State backButtonScale: number = 1; // è¿”å›žæŒ‰é’®ç¼©æ”¾çŠ¶æ€

  aboutToAppear(): void {
    // æ·»åŠ å¤´éƒ¨æ·¡å…¥åŠ¨ç”»
    animateTo({ duration: 800, curve: Curve.EaseOut }, () => {
      this.headerOpacity = 1;
    });

    new MQTTUtil().connect(
      (err: Error, data: MqttMessage) => {
        //å¦‚æžœæ²¡æœ‰å‡ºé”™å°±å¤„ç†æ•°æ®
        if (!err) {
          //è§£æžæŽ¥æ”¶åˆ°çš„æ•°æ®ä¸ºEnvironmentViewModelå¯¹è±¡
          this.item = JSON.parse(String(data.payload)) as EnvironmentViewModel;

          //å¦‚æžœå®žä¾‹ä¸ä¸ºç©ºå°±æ›´æ–°çŠ¶æ€å˜é‡
          if (!this.item) {
            this.item = new EnvironmentViewModel()
          }
        }
      }
    )
  }

  // AIæŒ‰é’®ç‚¹å‡»å¤„ç†
  private handleAIButtonPress() {
    animateTo({ duration: 150 }, () => {
      this.aiButtonScale = 0.95;
    });
  }

  private handleAIButtonRelease() {
    animateTo({ duration: 150 }, () => {
      this.aiButtonScale = 1;
    });
  }

  private navigateToAI() {
    router.pushUrl({
      url: 'pages/AI',
      params: {
        item: this.item
      }
    });
  }

  // è¿”å›žæŒ‰é’®ç‚¹å‡»å¤„ç†
  private handleBackButtonPress() {
    animateTo({ duration: 150 }, () => {
      this.backButtonScale = 0.9;
    });
  }

  private handleBackButtonRelease() {
    animateTo({ duration: 150 }, () => {
      this.backButtonScale = 1;
    });
  }

  private goBack() {
    router.back();
  }

  // ç¾ŽåŒ–çš„AIæŒ‰é’®ç»„ä»¶
  @Builder
  AIButton() {
    Row({ space: 12 }) {
      // AIå›¾æ ‡
      Image($r('app.media.ai_green_128'))
        .width(28)
        .height(28)
        .borderRadius(14)

      Column({ space: 2 }) {
        Text('AIæ™ºèƒ½åˆ†æž')
          .fontSize(14)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFFFFF')
        Text('ç‚¹å‡»èŽ·å–ä¸“ä¸šå…»æŠ¤å»ºè®®')
          .fontSize(10)
          .fontColor('#F0F8F0')
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // ç®­å¤´å›¾æ ‡
      Text('â†’')
        .fontSize(18)
        .fontColor('#FFFFFF')
        .fontWeight(FontWeight.Bold)
    }
    .width('94%')
    .height(55)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#81C784')
    .borderRadius(12)
    .scale({ x: this.aiButtonScale, y: this.aiButtonScale })
    .shadow({
      radius: 8,
      color: '#81C78420',
      offsetX: 0,
      offsetY: 4
    })
    .linearGradient({
      angle: 45,
      colors: [['#81C784', 0.0], ['#A5D6A7', 1.0]]
    })
    .onTouch((event) => {
      if (event.type === TouchType.Down) {
        this.handleAIButtonPress();
      } else if (event.type === TouchType.Up) {
        this.handleAIButtonRelease();
      }
    })
    .onClick(() => {
      this.navigateToAI();
    })
  }

  build() {
    Stack({ alignContent: Alignment.TopStart }) {
      // ä¸»è¦å†…å®¹
      Column({ space: 12 }) {
        // ç¾ŽåŒ–çš„å¤´éƒ¨ - è°ƒæ•´ä¸ºå³å¯¹é½å¸ƒå±€
        Row() {
          // å·¦ä¾§å ä½ç©ºé—´ï¼Œä¸ºè¿”å›žæŒ‰é’®ç•™å‡ºä½ç½®
          Column()
            .width(60)
            .height(50)
          
          // ä¸­é—´å¼¹æ€§ç©ºé—´
          Column()
            .layoutWeight(1)
          
          // æ ‡é¢˜é å³æ˜¾ç¤º
          Text("ðŸŒ± çŽ¯å¢ƒç›‘æµ‹ç³»ç»Ÿ")
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FFFFFF')
            .textAlign(TextAlign.Center)
            .width(200)
            .height(50)
            .borderRadius(12)
            .linearGradient({
              angle: 135,
              colors: [['#81C784', 0.0], ['#66BB6A', 1.0]]
            })
            .shadow({
              radius: 6,
              color: '#81C78420',
              offsetX: 0,
              offsetY: 3
            })
          
          // å³ä¾§å°é—´è·
          Column()
            .width(12)
        }
        .opacity(this.headerOpacity)
        .margin({ left: 8, right: 8 })
        .width('100%')

        // ä¸»è¦å†…å®¹åŒºåŸŸ - å‡å°‘é—´è·
        Column({ space: 8 }) {
          PottedPlantsComponent({ item: this.item })
          SwiperComponent({ item: this.item })
          
          // AIæŒ‰é’®
          this.AIButton()
        }
        .layoutWeight(1)
      }
      .height('100%')
      .width('100%')
      .padding({ top: 16, bottom: 16, left: 4, right: 4 })
      .linearGradient({
        angle: 180,
        colors: [['#F8FDF8', 0.0], ['#F1F8F1', 1.0]]
      })

      // è¿”å›žæŒ‰é’® - å®šä½åœ¨å·¦ä¸Šè§’
      Row() {
        Text('â†')
          .fontSize(18)
          .fontColor('#FFFFFF')
          .fontWeight(FontWeight.Bold)
      }
      .width(45)
      .height(45)
      .backgroundColor('#66BB6A')
      .borderRadius(22.5)
      .justifyContent(FlexAlign.Center)
      .alignItems(VerticalAlign.Center)
      .scale({ x: this.backButtonScale, y: this.backButtonScale })
      .shadow({
        radius: 6,
        color: '#66BB6A30',
        offsetX: 0,
        offsetY: 3
      })
      .margin({ left: 16, top: 25 })
      .onTouch((event) => {
        if (event.type === TouchType.Down) {
          this.handleBackButtonPress();
        } else if (event.type === TouchType.Up) {
          this.handleBackButtonRelease();
        }
      })
      .onClick(() => {
        this.goBack();
      })
    }
  }
}