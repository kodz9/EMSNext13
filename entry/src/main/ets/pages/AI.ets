import { AIComponent } from '../view/AIComponent';
import EnvironmentViewModel from '../viewmodel/EnvironmentViewModel';
import { MqttMessage } from '@ohos/mqtt';
import MQTTUtil from '../common/utils/MQTTUtil';
import router from '@ohos.router';

@Entry
@Component
struct Index {
  @State item: EnvironmentViewModel = new EnvironmentViewModel();
  @State titleOpacity: number = 0;
  @State contentOpacity: number = 0;
  @State backButtonScale: number = 1;

  aboutToAppear(): void {
    // æ·»åŠ è¿›å…¥åŠ¨ç”»
    setTimeout(() => {
      animateTo({ duration: 800, curve: Curve.EaseOut }, () => {
        this.titleOpacity = 1;
      });
    }, 100);
    
    setTimeout(() => {
      animateTo({ duration: 800, curve: Curve.EaseOut }, () => {
        this.contentOpacity = 1;
      });
    }, 300);

    new MQTTUtil().connect(
      (err: Error, data: MqttMessage) => {
        //å¦‚æžœæ²¡æœ‰å‡ºé”™å°±å¤„ç†æ•°æ®
        if (!err) {
          //è§£æžæŽ¥æ”¶åˆ°çš„æ•°æ®ä¸ºEnvironmentViewModelå¯¹è±¡
          this.item = JSON.parse(String(data.payload)) as EnvironmentViewModel;

          //å¦‚æžœå®žä¾‹ä¸ä¸ºç©ºå°±æ›´æ–°çŠ¶æ€å˜é‡
          if (!this.item) {
            this.item = new EnvironmentViewModel()
          }
        }
      }
    )
  }

  private handleBackButtonPress() {
    animateTo({ duration: 150 }, () => {
      this.backButtonScale = 0.95;
    });
  }

  private handleBackButtonRelease() {
    animateTo({ duration: 150 }, () => {
      this.backButtonScale = 1;
    });
  }

  private goBack() {
    router.back();
  }

  @Builder
  HeaderBuilder() {
    Row() {
      // è£…é¥°æ€§å›¾æ ‡
      Text('ðŸ¤–')
        .fontSize(24)
        .margin({ right: 12 })
      
      Column() {
        Text("æ™ºèƒ½åŠ©æ‰‹")
          .fontSize(22)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)
        
        Text("AIé©±åŠ¨çš„æ¤ç‰©å…»æŠ¤ä¸“å®¶")
          .fontSize(12)
          .fontColor('#E8F5E8')
          .margin({ top: 2 })
      }
      .alignItems(HorizontalAlign.Start)
      
      Blank()
      
      // çŠ¶æ€æŒ‡ç¤ºç¯
      Row() {
        Circle({ width: 8, height: 8 })
          .fill('#4CAF50')
        Text('åœ¨çº¿')
          .fontSize(12)
          .fontColor('#E8F5E8')
          .margin({ left: 6 })
      }
    }
    .width('100%')
    .height(70)
    .padding({ left: 20, right: 20, top: 10, bottom: 10 })
    .linearGradient({
      angle: 90,
      colors: [['#4CAF50', 0.0], ['#388E3C', 1.0]]
    })
    .shadow({
      radius: 12,
      color: '#4CAF5030',
      offsetX: 0,
      offsetY: 4
    })
    .opacity(this.titleOpacity)
  }

  build() {
    Stack() {
      Column() {
        this.HeaderBuilder()
        
        // ä¸»è¦å†…å®¹åŒºåŸŸ
        Column() {
          AIComponent({ item: this.item })
        }
        .width('100%')
        .height('100%')
        .padding({ top: 16 })
        .opacity(this.contentOpacity)
      }
      .height('100%')
      .width('100%')
      .linearGradient({
        angle: 180,
        colors: [['#F1F8E9', 0.0], ['#E8F5E8', 0.5], ['#FFFFFF', 1.0]]
      })

      // è¿”å›žæŒ‰é’® - ä½äºŽå·¦ä¸‹è§’
      Button() {
        Row({ space: 8 }) {
          Image($r('sys.media.ohos_ic_back'))
            .width(20)
            .height(20)
            .fillColor(Color.White)
          Text('è¿”å›ž')
            .fontSize(14)
            .fontColor(Color.White)
            .fontWeight(500)
        }
      }
      .width(80)
      .height(40)
      .backgroundColor('#4CAF50')
      .borderRadius(20)
      .scale({ x: this.backButtonScale, y: this.backButtonScale })
      .shadow({
        radius: 8,
        color: '#4CAF5040',
        offsetX: 0,
        offsetY: 4
      })
      .onTouch((event) => {
        if (event.type === TouchType.Down) {
          this.handleBackButtonPress();
        } else if (event.type === TouchType.Up) {
          this.handleBackButtonRelease();
        }
      })
      .onClick(() => {
        this.goBack();
      })
      .position({ x: 20, y: '90%' })
    }
    .width('100%')
    .height('100%')
  }
}