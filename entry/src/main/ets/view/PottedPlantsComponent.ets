import { StatusArray } from "../common/constants/Constant";
import EnvironmentViewModel from "../viewmodel/EnvironmentViewModel";
import { CellComponent } from "./CellComponent";

// çŠ¶æ€å¾½ç« èƒŒæ™¯é¢œè‰²ç”Ÿæˆæ–¹æ³•
function getStatusBadgeColor(stat: number): string {
  const baseColors: string[] = [
    '#00FF00', // ç»¿è‰²
    '#FFFF00', // é»„è‰²
    '#FF0000'  // çº¢è‰²
  ];

  return baseColors[stat] + '26'; // æ·»åŠ é€æ˜åº¦
}

// è·å–çŠ¶æ€æ¸å˜è‰² - è°ƒæ•´ä¸ºæ›´æµ…çš„é¢œè‰²
function getStatusGradientColors(stat: number): [string, number][] {
  switch (stat) {
    case 0: return [['#A5D6A7', 0.0], ['#C8E6C9', 1.0]]; // æ›´æµ…çš„ç»¿è‰²
    case 1: return [['#FFE082', 0.0], ['#FFF3C4', 1.0]]; // æ›´æµ…çš„é»„è‰²
    case 2: return [['#FFAB91', 0.0], ['#FFCCBC', 1.0]]; // æ›´æµ…çš„çº¢è‰²
    default: return [['#E0E0E0', 0.0], ['#F5F5F5', 1.0]]; // æ›´æµ…çš„ç°è‰²
  }
}

@Extend(Line)
function lineStyle(backgroundColor: Color) {
  .width('94%')
  .height(1)
  .backgroundColor(backgroundColor)
  .margin({ top: 4, bottom: 4 })
  .borderRadius(0.5)
}

@Component
export struct PottedPlantsComponent {
  @Prop
  item: EnvironmentViewModel;

  // ä½¿ç”¨çŠ¶æ€å˜é‡æ§åˆ¶ç¼©æ”¾æ•ˆæœ
  @State scaleValue: number = 1;
  @State cardOpacity: number = 0;
  @State badgeScale: number = 1;

  // ä¿®å¤ï¼šä½¿ç”¨é¢„å®šä¹‰çš„é¢œè‰²å¸¸é‡ä»£æ›¿æ„é€ å‡½æ•°
  private shadowColor: Color = Color.Gray;

  aboutToAppear() {
    // æ·»åŠ å¡ç‰‡æ·¡å…¥åŠ¨ç”»
    animateTo({ duration: 600, curve: Curve.EaseOut }, () => {
      this.cardOpacity = 1;
    });
  }

  // çŠ¶æ€å¾½ç« æ„å»ºå™¨
  @Builder
  StatusBadge() {
    Column() {
      Text(StatusArray[this.item.stat])
        .fontColor(this.getFontColor())
        .fontSize(14)
        .fontWeight(FontWeight.Bold)
    }
    .padding({ left: 12, right: 12, top: 6, bottom: 6 })
    .borderRadius(20)
    .linearGradient({
      angle: 45,
      colors: getStatusGradientColors(this.item.stat)
    })
    .scale({ x: this.badgeScale, y: this.badgeScale })
    .shadow({
      radius: 6,
      color: this.getBackgroudColorString() + '20', // ä½¿ç”¨å­—ç¬¦ä¸²æ–¹æ³•
      offsetX: 0,
      offsetY: 2
    })
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      // å¾½ç« ç‚¹å‡»åŠ¨ç”»
      animateTo({ duration: 200 }, () => {
        this.badgeScale = 0.9;
      });
      setTimeout(() => {
        animateTo({ duration: 200 }, () => {
          this.badgeScale = 1;
        });
      }, 200);
    })
  }

  private handleClick() {
    animateTo({ duration: 200, curve: Curve.EaseInOut }, () => {
      this.scaleValue = 0.98;
    });

    setTimeout(() => {
      animateTo({ duration: 200, curve: Curve.EaseOut }, () => {
        this.scaleValue = 1;
      });
    }, 200);
  }

  build() {
    Column() {
      // çŠ¶æ€å¾½ç« å¤´éƒ¨
      Row() {
        // æ·»åŠ çŠ¶æ€å›¾æ ‡
        Text(this.getStatusIcon())
          .fontSize(20)
          .margin({ right: 8 })
        
        this.StatusBadge()
      }
      .width('100%')
      .margin({ bottom: 16 })
      .justifyContent(FlexAlign.End)
      .alignItems(VerticalAlign.Center)

      // æ•°æ®è¡Œ
      Column({ space: 8 }) {
        CellComponent({
          title: "ğŸŒ¡ï¸ ç©ºæ°”æ¸©åº¦ï¼š",
          value: `${this.item.temp} Â°C`,
          color: this.getFontColor()
        })

        Line().lineStyle(this.getFontColor())

        CellComponent({
          title: "ğŸ’§ ç©ºæ°”æ¹¿åº¦ï¼š",
          value: `${this.item.hum} %`,
          color: this.getFontColor()
        })

        Line().lineStyle(this.getFontColor())

        CellComponent({
          title: "âš ï¸ å¯ç‡ƒæ°”ä½“ï¼š",
          value: `${this.item.gas} PPM`,
          color: this.getFontColor()
        })
      }
    }
    .linearGradient({
      angle: 135,
      colors: getStatusGradientColors(this.item.stat)
    })
    .margin({ left: 12, right: 12, top: 8, bottom: 8 })
    .padding(20)
    .borderRadius(20)
    .width('94%')
    .opacity(this.cardOpacity)
    .shadow({
      radius: 16,
      color: this.getBackgroudColorString() + '15', // ä½¿ç”¨å­—ç¬¦ä¸²æ–¹æ³•
      offsetX: 0,
      offsetY: 8
    })
    .scale({ x: this.scaleValue, y: this.scaleValue })
    .onClick(() => this.handleClick())
  }

  getStatusIcon(): string {
    switch (this.item.stat) {
      case 0: return 'âœ…';
      case 1: return 'âš ï¸';
      case 2: return 'ğŸš¨';
      default: return 'â“';
    }
  }

  // è¿”å›å­—ç¬¦ä¸²é¢œè‰²å€¼ï¼Œç”¨äºé˜´å½±ç­‰éœ€è¦å­—ç¬¦ä¸²çš„åœ°æ–¹
  getBackgroudColorString(): string {
    switch (this.item.stat) {
      case 0: return '#A5D6A7'; // æ›´æµ…çš„ç»¿è‰²
      case 1: return '#FFE082'; // æ›´æµ…çš„é»„è‰²
      case 2: return '#FFAB91'; // æ›´æµ…çš„çº¢è‰²
      default: return '#E0E0E0'; // æ›´æµ…çš„ç°è‰²
    }
  }

  // è¿”å›Colorç±»å‹ï¼Œç”¨äºéœ€è¦Colorç±»å‹çš„åœ°æ–¹
  getBackgroudColor(): Color {
    switch (this.item.stat) {
      case 0: return Color.Green; // ä½¿ç”¨é¢„å®šä¹‰çš„ç»¿è‰²
      case 1: return Color.Yellow; // ä½¿ç”¨é¢„å®šä¹‰çš„é»„è‰²
      case 2: return Color.Red; // ä½¿ç”¨é¢„å®šä¹‰çš„çº¢è‰²
      default: return Color.Gray; // ä½¿ç”¨é¢„å®šä¹‰çš„ç°è‰²
    }
  }

  getFontColor(): Color {
    switch (this.item.stat) {
      case 0: return Color.Green; // æ·±ç»¿è‰²æ–‡å­—
      case 1: return Color.Orange; // æ©™è‰²æ–‡å­—
      case 2: return Color.Red; // æ·±çº¢è‰²æ–‡å­—
      default: return Color.Black; // é»‘è‰²æ–‡å­—
    }
  }
}